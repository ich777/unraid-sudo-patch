<?xml version='1.0' standalone='yes'?>
<!DOCTYPE PLUGIN [
  <!ENTITY name      "sudo-patch">
  <!ENTITY author    "ich777">
  <!ENTITY version   "2021.01.28">
  <!ENTITY gitURL    "https://github.com/&author;/unraid-&name;/raw/master">
  <!ENTITY pluginURL "&gitURL;/&name;.plg">
  <!ENTITY plugin    "/boot/config/plugins/&name;">
  <!ENTITY emhttp    "/usr/local/emhttp/plugins/&name;">
]>

<PLUGIN  name="&name;" author="&author;" version="&version;" pluginURL="&pluginURL;" min="6.8.2" max="6.9.0-RC2" icon="fa-shield ">

<CHANGES>

###2021.01.28
- Initial release

</CHANGES>

<FILE Name="&emhttp;/README.md">
<INLINE>
**sudo patch CVE-2021-3156**

This Plugin updates sudo to version 1.9.5p2 in regard to CVE-2021-3156  
sudo before 1.9.5p2 has a Heap-based Buffer Overflow, allowing privilege escalation to root via "sudoedit -s" and a command-line argument that ends with a single backslash character.  
Source: http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3156
</INLINE>
</FILE>

<FILE Run="/bin/bash">
<INLINE>
if [ ! -d "&plugin;/packages/" ]; then
  mkdir -p "&plugin;/packages/"
fi

download() {
#Download sudo 1.9.5p2
if wget -q -nc --show-progress --progress=bar:force:noscroll -O "&plugin;/packages/sudo-1.9.5p2-x86_64-1_slack14.2.txz" "http://slackware.cs.utah.edu/pub/slackware/slackware64-14.2/patches/packages/sudo-1.9.5p2-x86_64-1_slack14.2.txz" ; then
  echo
  echo "------------Sucessfully downloaded sudo 1.9.5p2, please wait...!---------------"
else
  echo
  echo "-----ERROR - ERROR - ERROR - ERROR - ERROR - ERROR - ERROR - ERROR - ERROR------"
  echo "------------------------Can't download sudo 1.9.5p2-----------------------------"
  rm -rf &plugin;
  rm -rf &emhttp;
  exit 1
fi
}

check() {
if [ ! -f "&plugin;/packages/sudo-1.9.5p2-x86_64-1_slack14.2.txz" ]; then
  echo
  echo "+=============================================================================="
  echo "| WARNING - WARNING - WARNING - WARNING - WARNING - WARNING - WARNING - WARNING"
  echo "|"
  echo "| Don't close this window with the red 'X' in the top right corner until the 'DONE' button is displayed!"
  echo "|"
  echo "| WARNING - WARNING - WARNING - WARNING - WARNING - WARNING - WARNING - WARNING"
  echo "+=============================================================================="
  echo
  echo "-----------------Downloading sudo 1.9.5p2, please wait...!---------------------"
  echo "-----------This could take some time, please don't close this window!----------"
  download
else
  echo
  echo "-------------------------sudo 1.9.5p2 found locally!---------------------------"
fi
}

install() {
#Install sudo 1.9.5p2
/sbin/installpkg "&plugin;/packages/sudo-1.9.5p2-x86_64-1_slack14.2.txz"
exit 0
}

#Check if sudo 1.9.5p2 already downloaded
check
install > /dev/null
echo
echo "------------------Installation of sudo 1.9.5p2 successfull---------------------"
echo
fi
</INLINE>
</FILE>

<FILE Run="/bin/bash" Method="remove">
<INLINE>

echo "---------------------------------------"
echo "----Uninstalling sudo 1.9.5p2 Patch----"
echo "---------------------------------------"
# Remove plugin related files
rm -rf &plugin;
rm -rf &emhttp;
echo
echo "----------------------------------------------------------------------------"
echo "--------sudo 1.9.5p2 Patch uninstalled, please reboot your server!----------"
echo "----------------------------------------------------------------------------"
echo

</INLINE>
</FILE>
</PLUGIN>
